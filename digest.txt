Directory structure:
└── Application1/
    └── main.py

================================================
FILE: main.py
================================================
import os
from fastapi import FastAPI, HTTPException, Query, Body, status, Path
from pydantic import BaseModel
from typing import List, Optional
from dotenv import load_dotenv
from supabase import create_client, Client

# --- 1. Configurare & Conexiune ---
load_dotenv()

app = FastAPI(
    title="QuickWash API",
    description="Backend V3: ArhitecturÄƒ ierarhicÄƒ (Nested Routes) pentru SpÄƒlÄƒtorii È™i Boxe."
)

SUPABASE_URL: str = os.environ.get("SUPABASE_URL")
SUPABASE_KEY: str = os.environ.get("SUPABASE_KEY")

if not SUPABASE_URL or not SUPABASE_KEY:
    raise RuntimeError("SUPABASE_URL sau SUPABASE_KEY lipsesc din fiÈ™ierul .env")

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)


# ==========================================
# 2. MODELE DE DATE (Pydantic Schemas)
# ==========================================

# --- SpÄƒlÄƒtorii ---
class SpalatorieCreate(BaseModel):
    nume: str
    adresa: Optional[str] = None
    program_functionare: Optional[str] = "00:00 - 24:00"
    latitudine: float
    longitudine: float

class SpalatorieResponse(BaseModel):
    id: str
    nume: str
    adresa: Optional[str]
    latitudine: float
    longitudine: float
    distanta_km: Optional[float] = None # OpÈ›ional, apare doar la cÄƒutare

# --- Boxe ---
class BoxaBase(BaseModel):
    nume_boxa: str
    pret_rezervare_lei: float = 15.0
    timp_rezervare_minute: int = 60
    is_available: bool = True

class BoxaCreate(BoxaBase):
    # NOTÄ‚: Am scos 'spalatorie_id' de aici. ÃŽl luÄƒm din URL!
    pass

class BoxaUpdate(BaseModel):
    nume_boxa: Optional[str] = None
    pret_rezervare_lei: Optional[float] = None
    timp_rezervare_minute: Optional[int] = None
    is_available: Optional[bool] = None

class BoxaResponse(BoxaBase):
    boxa_id: str
    spalatorie_id: str


# ==========================================
# 3. RUTE API (Endpoints)
# ==========================================

@app.get("/", summary="Health Check")
def read_root():
    return {"status": "QuickWash API V3 este live!"}

# ---------------------------
# A. SPÄ‚LÄ‚TORII (Rute Principale)
# ---------------------------

@app.post("/spalatorii", status_code=status.HTTP_201_CREATED, summary="AdaugÄƒ SpÄƒlÄƒtorie")
def add_spalatorie(spalatorie: SpalatorieCreate = Body(...)):
    try:
        data_to_insert = spalatorie.model_dump()
        response = supabase.table('spalatorii').insert({
            "nume": data_to_insert['nume'],
            "adresa": data_to_insert['adresa'],
            "program_functionare": data_to_insert['program_functionare'],
            "locatie": f"SRID=4326;POINT({data_to_insert['longitudine']} {data_to_insert['latitudine']})"
        }).execute()

        if response.data:
            return response.data[0]
        raise HTTPException(status_code=500, detail="Eroare la salvare.")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/spalatorii-apropiate", response_model=List[SpalatorieResponse], summary="CÄƒutare Geo")
def get_spalatorii_apropiate(
    lat: float = Query(..., description="Lat user"),
    lon: float = Query(..., description="Lon user"),
    raza_km: float = Query(5.0, description="Raza Ã®n km")
):
    """
    ReturneazÄƒ spÄƒlÄƒtoriile cu cel puÈ›in o boxÄƒ liberÄƒ.
    """
    try:
        response = supabase.rpc(
            'gaseste_apropiate',
            {'user_lat': lat, 'user_lon': lon, 'raza_km': raza_km}
        ).execute()
        
        if response.data:
            return [SpalatorieResponse(**item) for item in response.data]
        return []
    except Exception as e:
        print(f"Eroare: {e}")
        raise HTTPException(status_code=500, detail=f"Eroare server: {str(e)}")


# ---------------------------
# B. BOXE (Rute Nested / Ierarhice)
# ---------------------------

# 1. LISTARE: GET /spalatorii/{id}/boxe
@app.get("/spalatorii/{spalatorie_id}/boxe", response_model=List[BoxaResponse], summary="Vezi toate boxele unei locaÈ›ii")
def get_boxe_spalatorie(spalatorie_id: str):
    try:
        response = supabase.table('boxe').select('*').eq('spalatorie_id', spalatorie_id).execute()
        return response.data
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# 2. DETALII: GET /spalatorii/{id}/boxe/{boxa_id} (NOU)
@app.get("/spalatorii/{spalatorie_id}/boxe/{boxa_id}", response_model=BoxaResponse, summary="Vezi o boxÄƒ specificÄƒ")
def get_single_boxa(
    spalatorie_id: str, 
    boxa_id: str
):
    try:
        # CÄƒutÄƒm boxa care are SI id-ul corect SI aparÈ›ine spÄƒlÄƒtoriei corecte (siguranÈ›Äƒ dublÄƒ)
        response = supabase.table('boxe').select('*')\
            .eq('boxa_id', boxa_id)\
            .eq('spalatorie_id', spalatorie_id)\
            .execute()
        
        if response.data:
            return response.data[0]
        raise HTTPException(status_code=404, detail="Boxa nu a fost gÄƒsitÄƒ Ã®n aceastÄƒ spÄƒlÄƒtorie.")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# 3. CREARE: POST /spalatorii/{id}/boxe
@app.post("/spalatorii/{spalatorie_id}/boxe", status_code=status.HTTP_201_CREATED, response_model=BoxaResponse, summary="AdaugÄƒ BoxÄƒ")
def adauga_boxa(
    spalatorie_id: str,
    boxa: BoxaCreate = Body(...)
):
    """
    AdaugÄƒ o boxÄƒ. ID-ul spÄƒlÄƒtoriei este luat automat din URL.
    """
    try:
        # PregÄƒtim datele: luÄƒm ce e Ã®n body È™i adÄƒugÄƒm ID-ul din URL
        insert_data = boxa.model_dump()
        insert_data['spalatorie_id'] = spalatorie_id
        
        response = supabase.table('boxe').insert(insert_data).execute()
        
        if response.data:
            return response.data[0]
        raise HTTPException(status_code=500, detail="Eroare la creare.")
    except Exception as e:
        if "foreign key" in str(e):
            raise HTTPException(status_code=404, detail="SpÄƒlÄƒtoria (ID URL) nu existÄƒ.")
        raise HTTPException(status_code=500, detail=str(e))

# 4. UPDATE: PATCH /spalatorii/{id}/boxe/{boxa_id}
@app.patch("/spalatorii/{spalatorie_id}/boxe/{boxa_id}", response_model=BoxaResponse, summary="Update BoxÄƒ")
def update_boxa(
    spalatorie_id: str,
    boxa_id: str,
    boxa_update: BoxaUpdate
):
    try:
        update_data = boxa_update.model_dump(exclude_unset=True)
        if not update_data:
            raise HTTPException(status_code=400, detail="FÄƒrÄƒ date de update.")

        # Facem update doar dacÄƒ boxa corespunde È™i cu ID-ul È™i cu SpÄƒlÄƒtoria
        response = supabase.table('boxe').update(update_data)\
            .eq('boxa_id', boxa_id)\
            .eq('spalatorie_id', spalatorie_id)\
            .execute()
        
        if response.data:
            return response.data[0]
        raise HTTPException(status_code=404, detail="Boxa nu existÄƒ sau nu aparÈ›ine acestei spÄƒlÄƒtorii.")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# 5. DELETE: DELETE /spalatorii/{id}/boxe/{boxa_id}
@app.delete("/spalatorii/{spalatorie_id}/boxe/{boxa_id}", status_code=status.HTTP_204_NO_CONTENT, summary="È˜terge BoxÄƒ")
def sterge_boxa(
    spalatorie_id: str,
    boxa_id: str
):
    try:
        response = supabase.table('boxe').delete()\
            .eq('boxa_id', boxa_id)\
            .eq('spalatorie_id', spalatorie_id)\
            .execute()
            
        if not response.data:
             raise HTTPException(status_code=404, detail="Boxa nu a fost gÄƒsitÄƒ.")
        return None
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)

